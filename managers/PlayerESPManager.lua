--[[
	PlayerESPManager
	
	Manages the player part of esp.
]]--

---<< SERVICES >>---
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")


---<< LIBRARIES >>---
local ESPLibrary = shared.Loadstring("libraries/ESPLibrary.lua")()


---<< CONSTANTS >>---
local LocalPlayer = Players.LocalPlayer
local ESPUpdateName = shared.RunServiceName .. "-ESPUpdate"


---<< VARIABLES >>---
local lastUpdate = tick()


---<< FUNCTIONS >>---
local function isTeammate(player)
	if player.Neutral and LocalPlayer.Neutral then
		return true
	end

	return player.TeamColor == LocalPlayer.TeamColor
end

local function getTeamColor(player)
	return player.TeamColor.Color
end


---<< MODULE >>---
local PlayerESPManager = {}

PlayerESPManager.ESPLibrary = ESPLibrary
PlayerESPManager.Library = nil
PlayerESPManager.Settings = {
	Enabled = true,
	EnableKeybind = "V",
	TeamCheck = false,
	TeamColor = false,
	Cham = {
		Enabled = true,
		AlwaysOnTop = true,
		FillColor = Color3.fromRGB(255, 0, 0),
		OutlineColor = Color3.fromRGB(255, 255, 255),
		FillTransparency = 0.5,
		OutlineTransparency = 0
	}
}

function PlayerESPManager:SetLibrary(library)
	PlayerESPManager.Library = library
end

function PlayerESPManager:BuildESP(Window)
	local ESPTab = Window:AddTab("ESP")
	
	local PlayerGroupbox = ESPTab:AddLeftGroupbox("Player")
	local PlayerESPBox = ESPTab:AddLeftTabbox("ESP Types")
	local ChamBox = PlayerESPBox:AddTab("Cham")
	
	PlayerGroupbox:AddDivider()
	PlayerGroupbox:AddToggle("ESP_PLAYER_ENABLED", {
		Text = "ESP Enabled",
		Default = PlayerESPManager.Settings.Enabled,
		Tooltip = "Enable it to show ESPs."
	}):AddKeyPicker("ESP_PLAYER_ENABLEKEYBIND", {
		Text = "Enable ESP Keybind",
		Default = PlayerESPManager.Settings.EnableKeybind,
		Mode = "Toggle",
		SyncToggleState = true
	})
	PlayerGroupbox:AddToggle("ESP_PLAYER_TEAMCHECK", {
		Text = "Team Check",
		Default = PlayerESPManager.Settings.TeamCheck,
		Tooltip = "Color players green if they are your teammate."
	})
	PlayerGroupbox:AddToggle("ESP_PLAYER_TEAMCOLOR", {
		Text = "Team Color",
		Default = PlayerESPManager.Settings.TeamColor,
		Tooltip = "Set players esp color to their own team color."
	})
	
	ChamBox:AddDivider()
	ChamBox:AddToggle("ESP_PLAYER_CHAM_ENABLED", {
		Text = "Cham Enabled",
		Default = PlayerESPManager.Settings.Cham.Enabled,
		Tooltip = "Enable it to show Cham ESP."
	})
	ChamBox:AddToggle("ESP_PLAYER_CHAM_ALWAYSONTOP", {
		Text = "Always On Top",
		Default = PlayerESPManager.Settings.Cham.AlwaysOnTop,
		Tooltip = "Set cham esp to be always on top of everything."
	})
	ChamBox:AddDivider()
	ChamBox:AddLabel("Fill Color"):AddColorPicker("ESP_PLAYER_CHAM_FILLCOLOR", {
		Title = "Cham Fill Color",
		Default = PlayerESPManager.Settings.Cham.FillColor
	})
	ChamBox:AddLabel("Outline Color"):AddColorPicker("ESP_PLAYER_CHAM_OUTLINECOLOR", {
		Title = "Outline Fill Color",
		Default = PlayerESPManager.Settings.Cham.OutlineColor
	})
	ChamBox:AddSlider("ESP_PLAYER_CHAM_FILLTRANSPARENCY", {
		Text = "Fill Transparency",
		Default = PlayerESPManager.Settings.Cham.FillTransparency,
		Min = 0,
		Max = 1,
		Rounding = 2
	})
	ChamBox:AddSlider("ESP_PLAYER_CHAM_OUTLINETRANSPARENCY", {
		Text = "Outline Transparency",
		Default = PlayerESPManager.Settings.Cham.OutlineTransparency,
		Min = 0,
		Max = 1,
		Rounding = 2
	})
	
	do
		Toggles["ESP_PLAYER_ENABLED"]:OnChanged(function()
			PlayerESPManager.Settings.Enabled = Toggles["ESP_PLAYER_ENABLED"].Value
		end)
		Toggles["ESP_PLAYER_TEAMCHECK"]:OnChanged(function()
			PlayerESPManager.Settings.TeamCheck = Toggles["ESP_PLAYER_TEAMCHECK"].Value
		end)
		Toggles["ESP_PLAYER_TEAMCHECK"]:OnChanged(function()
			PlayerESPManager.Settings.TeamColor = Toggles["ESP_PLAYER_TEAMCHECK"].Value
		end)
		Toggles["ESP_PLAYER_CHAM_ENABLED"]:OnChanged(function()
			PlayerESPManager.Settings.Cham.Enabled = Toggles["ESP_PLAYER_CHAM_ENABLED"].Value
		end)
		Toggles["ESP_PLAYER_CHAM_ALWAYSONTOP"]:OnChanged(function()
			PlayerESPManager.Settings.Cham.AlwaysOnTop = Toggles["ESP_PLAYER_CHAM_ALWAYSONTOP"].Value
		end)
		Options["ESP_PLAYER_CHAM_FILLCOLOR"]:OnChanged(function()
			PlayerESPManager.Settings.Cham.FillColor = Options["ESP_PLAYER_CHAM_FILLCOLOR"].Value
		end)
		Options["ESP_PLAYER_CHAM_OUTLINECOLOR"]:OnChanged(function()
			PlayerESPManager.Settings.Cham.OutlineColor = Options["ESP_PLAYER_CHAM_OUTLINECOLOR"].Value
		end)
		Options["ESP_PLAYER_CHAM_FILLTRANSPARENCY"]:OnChanged(function()
			PlayerESPManager.Settings.Cham.FillTransparency = Options["ESP_PLAYER_CHAM_FILLTRANSPARENCY"].Value
		end)
		Options["ESP_PLAYER_CHAM_OUTLINETRANSPARENCY"]:OnChanged(function()
			PlayerESPManager.Settings.Cham.OutlineTransparency = Options["ESP_PLAYER_CHAM_OUTLINETRANSPARENCY"].Value
		end)
	end
	
	return ESPTab
end

function PlayerESPManager:CreateLocalPlayerCham()
	if not ESPLibrary:HasChamESP(LocalPlayer) then
		local cham = ESPLibrary:NewChamESP(LocalPlayer, true)
		cham.Objects.FillTransparency = 1
		cham.Objects.OutlineTransparency = 0.9999999
		cham.Objects.OutlineColor = Color3.fromRGB(255, 255, 255)
	end
end

function PlayerESPManager:Update()
	if (tick() - lastUpdate) < 0.15 then
		return
	end

	for _, player: Player in pairs(Players:GetPlayers()) do
		if player == LocalPlayer then
			continue
		end

		local character = player.Character
		if not character then
			continue
		end
		
		local cham = ESPLibrary:GetChamESP(player) or ESPLibrary:NewChamESP(player, true)

		if not PlayerESPManager.Settings.Enabled then
			cham:SetVisibility(false)
			continue
		end

		if PlayerESPManager.Settings.Cham.Enabled then
			cham:SetVisibility(true)
			
			local object = cham.Objects
			local fillColor
			local depthMode = PlayerESPManager.Settings.Cham.AlwaysOnTop
				and Enum.HighlightDepthMode.AlwaysOnTop
				or Enum.HighlightDepthMode.Occluded
			if PlayerESPManager.Settings.TeamColor then
				fillColor = getTeamColor(player)
			elseif PlayerESPManager.Settings.TeamCheck then
				if isTeammate(player) then
					fillColor = Color3.fromRGB(0, 255, 0)
				else
					fillColor = Color3.fromRGB(255, 0, 0)
				end
			else
				fillColor = PlayerESPManager.Settings.Cham.FillColor
			end

			object.FillColor = fillColor
			object.OutlineColor = PlayerESPManager.Settings.Cham.OutlineColor
			object.FillTransparency = PlayerESPManager.Settings.Cham.FillTransparency
			object.OutlineTransparency = PlayerESPManager.Settings.Cham.OutlineTransparency
			object.DepthMode = depthMode
			
			if object.Adornee ~= character then
				object.Adornee = character
			end
		else
			cham:SetVisibility(false)
		end
	end
end

function PlayerESPManager:Remove(player)
	local cham = ESPLibrary:GetChamESP(player)
	if cham then
		cham:Remove()
	end
end

function PlayerESPManager:Run()
	PlayerESPManager:Stop()

	PlayerESPManager:CreateLocalPlayerCham()
	RunService:BindToRenderStep(ESPUpdateName, 300, PlayerESPManager.Update)
	shared.EventConnections["OnPlayerRemoving-DeleteESP"] = Players.PlayerRemoving:Connect(function(player)
		PlayerESPManager:Remove(player)
	end)
end

function PlayerESPManager:Stop()
	RunService:UnbindFromRenderStep(ESPUpdateName)
	
	if shared.EventConnections["OnPlayerRemoving-DeleteESP"] then
		shared.EventConnections["OnPlayerRemoving-DeleteESP"]:Disconnect()
	end
end

return PlayerESPManager
